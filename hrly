/* ─── inside the final SELECT ─── */
CASE
  WHEN ARRAY_LENGTH(all_sims_mph) = 0 THEN []

  ELSE (
    -- 1️⃣ histogram (INT64) ➜ cast to FLOAT64 for UDF
    WITH float_hist AS (
      SELECT ARRAY(SELECT CAST(val AS FLOAT64) FROM UNNEST(speed_hist_mph) AS val) AS hist_f64
    )
    SELECT ARRAY(
             -- 2️⃣ percentile array from UDF (FLOAT64) ➜ round & cast to INT64
             SELECT CAST(ROUND(p * 1609.34) AS INT64)          -- mph → m/h
             FROM UNNEST(
                    `stl-datascience.ma_tt.histToPercentiles_js`(
                      (SELECT hist_f64 FROM float_hist)        -- ARRAY<FLOAT64>
                    )
                  ) AS p
           )
  )
END AS speedPercentiles
