INSERT INTO `stl-datascience.tomtom.tt_bulk_test_geohash6_wide`
WITH base AS (
  SELECT
    geohash,
    dsegId,
    TIMESTAMP_TRUNC(dateHour , HOUR)                   AS hour_ts,
    DIV(EXTRACT(MINUTE FROM dateHour), 15)             AS bin_idx,   -- 0‑3
    sampleSize,
    averageSpeedMetersPerHour           AS avg_spd,
    harmonicAverageSpeedMetersPerHour   AS harm_spd,
    medianSpeedMetersPerHour            AS med_spd,
    standardDeviationSpeedMetersPerHour AS std_spd,
    speedPercentiles
  FROM `stl-datascience.tomtom.tt_bulk_test_geohash6`
)

SELECT
  geohash,
  dsegId,
  hour_ts                                         AS dateHour,

  /* ───────────── 4‑slot arrays, built inline ───────────── */
  [ MAX(IF(bin_idx = 0, sampleSize, NULL)),
    MAX(IF(bin_idx = 1, sampleSize, NULL)),
    MAX(IF(bin_idx = 2, sampleSize, NULL)),
    MAX(IF(bin_idx = 3, sampleSize, NULL)) ]            AS sampleSize_15m,

  [ MAX(IF(bin_idx = 0, avg_spd, NULL)),
    MAX(IF(bin_idx = 1, avg_spd, NULL)),
    MAX(IF(bin_idx = 2, avg_spd, NULL)),
    MAX(IF(bin_idx = 3, avg_spd, NULL)) ]               AS avgSpeed_15m,

  [ MAX(IF(bin_idx = 0, harm_spd, NULL)),
    MAX(IF(bin_idx = 1, harm_spd, NULL)),
    MAX(IF(bin_idx = 2, harm_spd, NULL)),
    MAX(IF(bin_idx = 3, harm_spd, NULL)) ]              AS harmSpeed_15m,

  [ MAX(IF(bin_idx = 0, med_spd, NULL)),
    MAX(IF(bin_idx = 1, med_spd, NULL)),
    MAX(IF(bin_idx = 2, med_spd, NULL)),
    MAX(IF(bin_idx = 3, med_spd, NULL)) ]               AS medianSpeed_15m,

  [ MAX(IF(bin_idx = 0, std_spd, NULL)),
    MAX(IF(bin_idx = 1, std_spd, NULL)),
    MAX(IF(bin_idx = 2, std_spd, NULL)),
    MAX(IF(bin_idx = 3, std_spd, NULL)) ]               AS stdSpeed_15m,

  /* speedPercentiles needs ANY_VALUE because it’s already an ARRAY */
  [ STRUCT(ANY_VALUE(IF(bin_idx = 0, speedPercentiles, NULL)) AS percentiles),
    STRUCT(ANY_VALUE(IF(bin_idx = 1, speedPercentiles, NULL)) AS percentiles),
    STRUCT(ANY_VALUE(IF(bin_idx = 2, speedPercentiles, NULL)) AS percentiles),
    STRUCT(ANY_VALUE(IF(bin_idx = 3, speedPercentiles, NULL)) AS percentiles) ] AS speedPercentiles_15m,

  SUM(sampleSize)                                       AS total_sampleSize
FROM base
GROUP BY geohash, dsegId, dateHour;
